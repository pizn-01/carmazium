// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  BUYER
  SELLER
  DEALER
  CONTRACTOR
  FINANCE_PARTNER
  INSURANCE_PARTNER

  @@map("user_role")
}

enum FuelType {
  PETROL
  DIESEL
  HYBRID
  ELECTRIC
  LPG
  PLUGIN_HYBRID

  @@map("fuel_type")
}

enum TransmissionType {
  MANUAL
  AUTOMATIC
  CVT
  SEMI_AUTOMATIC

  @@map("transmission_type")
}

enum ListingType {
  AUCTION
  CLASSIFIED

  @@map("listing_type")
}

enum ListingStatus {
  DRAFT
  ACTIVE
  SOLD
  WITHDRAWN

  @@map("listing_status")
}

enum ServiceStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@map("service_status")
}

enum TransactionType {
  DEPOSIT
  FULL_PAYMENT
  COMMISSION
  REFUND

  @@map("transaction_type")
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED

  @@map("transaction_status")
}

enum FinanceApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED

  @@map("finance_application_status")
}

// ============================================================================
// USER MANAGEMENT & PROFILES
// ============================================================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String?
  supabaseAuthId    String?   @unique
  role              UserRole  @default(BUYER)
  firstName         String?
  lastName          String?
  phone             String?
  profileImage      String?
  isEmailVerified   Boolean   @default(false)
  isPhoneVerified   Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  // Relations
  dealerProfile           DealerProfile?
  contractorProfile       ContractorProfile?
  financePartnerProfile   PartnerProfile?    @relation("FinancePartner")
  insurancePartnerProfile PartnerProfile?    @relation("InsurancePartner")
  listings                Listing[]
  bids                    Bid[]
  serviceRequests         ServiceRequest[]
  financeApplications     FinanceApplication[]
  insuranceQuotes         InsuranceQuote[]
  transactions            Transaction[]
  chatRoomsAsInitiator    ChatRoom[]         @relation("Initiator")
  chatRoomsAsParticipant  ChatRoom[]         @relation("Participant")
  messages                Message[]
  watchlistItems          WatchlistItem[]

  @@map("users")
}

model DealerProfile {
  id                String    @id @default(uuid())
  userId            String    @unique
  companyName       String
  vatNumber         String    @unique
  registrationNumber String?
  businessAddress   String?
  isVerified        Boolean   @default(false)
  verificationDate  DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("dealer_profiles")
}

model ContractorProfile {
  id              String    @id @default(uuid())
  userId          String    @unique
  serviceTypes    String[]  // e.g., ["Detailing", "Mechanic", "Pre-purchase Inspection"]
  rating          Float     @default(0)
  totalReviews    Int       @default(0)
  serviceArea     String?   // e.g., "London, UK" or JSON for coordinates
  certifications  String[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceRequests  ServiceRequest[]

  @@map("contractor_profiles")
}

model PartnerProfile {
  id              String    @id @default(uuid())
  financeUserId   String?   @unique
  insuranceUserId String?   @unique
  partnerType     UserRole  // FINANCE_PARTNER or INSURANCE_PARTNER
  companyName     String
  apiKey          String    @unique
  callbackUrl     String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  financeUser             User?                     @relation(fields: [financeUserId], references: [id], onDelete: Cascade, name: "FinancePartner")
  insuranceUser           User?                     @relation(fields: [insuranceUserId], references: [id], onDelete: Cascade, name: "InsurancePartner")
  financeApplications     FinanceApplication[]
  insuranceQuotes         InsuranceQuote[]

  @@map("partner_profiles")
}

// ============================================================================
// VEHICLES & INVENTORY
// ============================================================================

model Vehicle {
  id              String           @id @default(uuid())
  vin             String?          @unique
  vrm             String?          @unique
  make            String
  model           String
  year            Int
  fuelType        FuelType?
  transmission    TransmissionType?
  mileage         Int?
  color           String?
  bodyType        String?
  doors           Int?
  seats           Int?
  engineSize      Int?      // cc, e.g. 2993
  bhp             Int?
  features        Json?     // Array of strings: ["Sunroof", "Heated Seats"]
  metadata        Json?     // JSONB for other flexible specs
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  listings Listing[]

  @@index([vin])
  @@index([vrm])
  @@map("vehicles")
}

model Listing {
  id              String         @id @default(uuid())
  vehicleId       String?
  sellerId        String?
  type            ListingType    @default(CLASSIFIED)
  status          ListingStatus  @default(DRAFT)
  title           String
  description     String?
  price           Decimal        @db.Decimal(12, 2)
  images          String[]       // Array of Supabase URLs
  slug            String         @unique
  viewCount       Int            @default(0)
  
  // Denormalized vehicle fields for simpler queries
  make            String?
  model           String?
  year            Int?
  mileage         Int?
  vrm             String?
  fuelType        FuelType?
  transmission    TransmissionType?
  color           String?
  doors           Int?
  seats           Int?
  engineSize      Int?
  bhp             Int?
  features        Json?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?

  // Relations
  vehicle         Vehicle?       @relation(fields: [vehicleId], references: [id])
  seller          User?          @relation(fields: [sellerId], references: [id])
  auction         Auction?
  bids            Bid[]
  financeApplications FinanceApplication[]
  insuranceQuotes InsuranceQuote[]
  transactions    Transaction[]
  chatRooms       ChatRoom[]
  watchlistItems  WatchlistItem[]

  @@index([sellerId])
  @@index([vehicleId])
  @@index([status])
  @@index([slug])
  @@map("listings")
}

// ============================================================================
// AUCTION ENGINE
// ============================================================================

model Auction {
  id              String    @id @default(uuid())
  listingId       String    @unique
  startTime       DateTime
  endTime         DateTime
  reservePrice    Decimal   @db.Decimal(12, 2)
  startingBid     Decimal   @db.Decimal(12, 2)
  minIncrement    Decimal   @db.Decimal(12, 2)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@map("auctions")
}

model Bid {
  id              String    @id @default(uuid())
  listingId       String
  bidderId        String
  amount          Decimal   @db.Decimal(12, 2)
  timestamp       DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  bidder  User    @relation(fields: [bidderId], references: [id])

  @@index([listingId, amount(sort: Desc)])
  @@index([bidderId])
  @@map("bids")
}

// ============================================================================
// SERVICES & INTEGRATIONS
// ============================================================================

model ServiceRequest {
  id              String         @id @default(uuid())
  contractorId    String
  requesterId     String
  listingId       String?
  serviceType     String
  status          ServiceStatus  @default(PENDING)
  description     String?
  quotedPrice     Decimal?       @db.Decimal(12, 2)
  acceptedPrice   Decimal?       @db.Decimal(12, 2)
  scheduledDate   DateTime?
  completedDate   DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?

  contractor ContractorProfile @relation(fields: [contractorId], references: [id])
  requester  User              @relation(fields: [requesterId], references: [id])

  @@index([contractorId])
  @@index([requesterId])
  @@index([status])
  @@map("service_requests")
}

model FinanceApplication {
  id              String                    @id @default(uuid())
  listingId       String
  userId          String
  partnerId       String
  depositAmount   Decimal                   @db.Decimal(12, 2)
  termMonths      Int
  monthlyPayment  Decimal?                  @db.Decimal(12, 2)
  status          FinanceApplicationStatus  @default(PENDING)
  approvalDate    DateTime?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  deletedAt       DateTime?

  listing Listing        @relation(fields: [listingId], references: [id])
  user    User           @relation(fields: [userId], references: [id])
  partner PartnerProfile @relation(fields: [partnerId], references: [id])

  @@index([listingId])
  @@index([userId])
  @@index([partnerId])
  @@index([status])
  @@map("finance_applications")
}

model InsuranceQuote {
  id              String    @id @default(uuid())
  listingId       String
  userId          String
  partnerId       String
  coverageType    String
  quotedPrice     Decimal   @db.Decimal(12, 2)
  status          String    @default("PENDING")
  expiryDate      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  listing Listing        @relation(fields: [listingId], references: [id])
  user    User           @relation(fields: [userId], references: [id])
  partner PartnerProfile @relation(fields: [partnerId], references: [id])

  @@index([listingId])
  @@index([userId])
  @@index([partnerId])
  @@map("insurance_quotes")
}

// ============================================================================
// TRANSACTIONS & MESSAGING
// ============================================================================

model Transaction {
  id              String             @id @default(uuid())
  listingId       String
  userId          String
  amount          Decimal            @db.Decimal(12, 2)
  type            TransactionType
  status          TransactionStatus  @default(PENDING)
  stripePaymentId String?            @unique
  description     String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  deletedAt       DateTime?

  listing Listing @relation(fields: [listingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@index([listingId])
  @@index([userId])
  @@index([status])
  @@map("transactions")
}

model ChatRoom {
  id              String    @id @default(uuid())
  initiatorId     String
  participantId   String
  listingId       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  initiator   User      @relation("Initiator", fields: [initiatorId], references: [id])
  participant User      @relation("Participant", fields: [participantId], references: [id])
  listing     Listing?  @relation(fields: [listingId], references: [id])
  messages    Message[]

  @@unique([initiatorId, participantId])
  @@index([initiatorId])
  @@index([participantId])
  @@map("chat_rooms")
}

model Message {
  id              String    @id @default(uuid())
  chatRoomId      String
  senderId        String
  content         String
  isRead          Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation(fields: [senderId], references: [id])

  @@index([chatRoomId])
  @@index([senderId])
  @@map("messages")
}

// ============================================================================
// WATCHLIST
// ============================================================================

model WatchlistItem {
  id              String    @id @default(uuid())
  userId          String
  listingId       String
  createdAt       DateTime  @default(now())
  
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
  @@map("watchlist_items")
}
